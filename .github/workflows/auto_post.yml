name: X自動投稿

on:
  schedule:
    # 3時間ごと（1日8回）※無料枠内に収める
    - cron: '0 22,23,3,4,9,12,13,14 * * *'
  workflow_dispatch:  # 手動実行も可能

jobs:
  post:
    runs-on: ubuntu-latest
    timeout-minutes: 100

    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4

      - name: Pythonセットアップ
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Google Chromeをインストール
        run: |
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/google-chrome.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: 日本語フォントをインストール
        run: |
          sudo apt-get install -y fonts-noto-cjk

      - name: Python依存パッケージをインストール
        run: |
          pip install selenium python-dotenv Pillow google-generativeai

      - name: Cookieを復元
        env:
          X_COOKIES_BASE64: ${{ secrets.X_COOKIES_BASE64 }}
        run: |
          python -c "
          import base64, os
          data = os.environ['X_COOKIES_BASE64']
          with open('x_cookies.pkl', 'wb') as f:
              f.write(base64.b64decode(data))
          print('[OK] Cookieファイルを復元しました')
          "

      - name: 投稿を実行（ヘッドレス）
        env:
          CI: true
          RANDOM_DELAY_MINUTES: '60'
          X_USERNAME: ${{ secrets.X_USERNAME }}
          X_PASSWORD: ${{ secrets.X_PASSWORD }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python ci_post.py

      - name: Cookie期限切れ時に再ログイン
        if: failure()
        env:
          CI: true
          X_USERNAME: ${{ secrets.X_USERNAME }}
          X_PASSWORD: ${{ secrets.X_PASSWORD }}
        run: |
          python -c "
          from twitter_client import TwitterClient
          client = TwitterClient()
          if client.login_auto():
              print('[OK] 再ログインしてCookieを更新しました')
          else:
              print('[ERROR] 再ログインに失敗しました')
              exit(1)
          "

      - name: Cookieを自動更新
        if: always()
        env:
          GH_TOKEN: ${{ secrets.COOKIE_UPDATE_TOKEN }}
        run: |
          if [ -f x_cookies.pkl ]; then
            python -c "
          import base64
          with open('x_cookies.pkl', 'rb') as f:
              data = base64.b64encode(f.read()).decode()
          print(data)
          " | gh secret set X_COOKIES_BASE64
            echo '[OK] Cookieを自動更新しました'
          else
            echo '[WARN] x_cookies.pkl が見つかりません'
          fi

      - name: 投稿履歴をコミット
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add post_history.json post_rotation.json || true
          git diff --staged --quiet || git commit -m "Update post history [skip ci]"
          git push || true

      - name: 失敗時にIssueで通知
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.COOKIE_UPDATE_TOKEN }}
        run: |
          existing=$(gh issue list --label "bot-alert" --state open --limit 1 --json number -q '.[0].number')
          if [ -z "$existing" ]; then
            gh issue create \
              --title "⚠️ 自動投稿に失敗しました" \
              --body "投稿と再ログインの両方が失敗しました。Cookieの手動更新が必要です。" \
              --label "bot-alert"
          fi

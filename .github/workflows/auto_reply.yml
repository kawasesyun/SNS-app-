name: X自動リプライ

on:
  schedule:
    # 1日3回（JST 9, 14, 20時）
    - cron: '0 0,5,11 * * *'
  workflow_dispatch:  # 手動実行も可能

jobs:
  reply:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4

      - name: Pythonセットアップ
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Google Chromeをインストール
        run: |
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/google-chrome.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: Python依存パッケージをインストール
        run: |
          pip install selenium python-dotenv google-generativeai

      - name: Cookieを復元
        env:
          X_COOKIES_BASE64: ${{ secrets.X_COOKIES_BASE64 }}
        run: |
          python -c "
          import base64, os
          data = os.environ['X_COOKIES_BASE64']
          with open('x_cookies.pkl', 'wb') as f:
              f.write(base64.b64decode(data))
          print('[OK] Cookieファイルを復元しました')
          "

      - name: 自動リプライを実行
        env:
          CI: true
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python auto_reply.py

      - name: リプライ履歴をコミット
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add reply_history.json || true
          git diff --staged --quiet || git commit -m "Update reply history [skip ci]"
          git push || true

name: Cookie定期リフレッシュ

on:
  schedule:
    # 1日1回Cookieをリフレッシュ（期限切れ防止）
    - cron: '0 10 * * *'
  workflow_dispatch:

jobs:
  refresh:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4

      - name: Pythonセットアップ
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Google Chromeをインストール
        run: |
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/google-chrome.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: Python依存パッケージをインストール
        run: pip install selenium python-dotenv

      - name: Cookieを復元
        env:
          X_COOKIES_BASE64: ${{ secrets.X_COOKIES_BASE64 }}
        run: |
          python -c "
          import base64, os
          data = os.environ['X_COOKIES_BASE64']
          with open('x_cookies.pkl', 'wb') as f:
              f.write(base64.b64decode(data))
          print('[OK] Cookieファイルを復元しました')
          "

      - name: Cookieの有効性を確認してリフレッシュ
        env:
          CI: 'true'
          X_USERNAME: ${{ secrets.X_USERNAME }}
          X_PASSWORD: ${{ secrets.X_PASSWORD }}
        run: |
          python -c "
          import os, time
          from twitter_client import TwitterClient
          client = TwitterClient()
          client._create_driver(headless=True)
          if client._login_with_cookies():
              time.sleep(3)
              client._save_cookies()
              print('[OK] Cookieリフレッシュ成功')
          else:
              print('[WARN] Cookie無効。再ログインを試みます...')
              if client.driver:
                  client.driver.quit()
                  client.driver = None
              if client.login_auto():
                  print('[OK] 再ログイン成功')
              else:
                  print('[ERROR] 再ログイン失敗')
                  exit(1)
          if client.driver:
              client.driver.quit()
          "

      - name: Cookieを自動更新
        env:
          GH_TOKEN: ${{ secrets.COOKIE_UPDATE_TOKEN }}
        run: |
          if [ -f x_cookies.pkl ]; then
            python -c "
          import base64
          with open('x_cookies.pkl', 'rb') as f:
              data = base64.b64encode(f.read()).decode()
          print(data)
          " | gh secret set X_COOKIES_BASE64
            echo '[OK] Cookieを自動更新しました'
          fi

      - name: 失敗時にIssueで通知
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.COOKIE_UPDATE_TOKEN }}
        run: |
          gh issue create \
            --title "⚠️ Cookie期限切れ: 手動ログインが必要です" \
            --body "Cookieの自動リフレッシュに失敗しました。

          **対応方法:**
          1. ローカルPCで \`python -c \"from twitter_client import TwitterClient; TwitterClient().login_manual()\"\` を実行
          2. 生成されたbase64をGitHub Secretsの \`X_COOKIES_BASE64\` に貼り付け

          このIssueは自動生成されました。" \
            --label "bug"
